<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Introduction to testdat</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to testdat</h1>



<p>testdat is a package designed to ease data validation, particularly
for complex data processing, inspired by software unit testing. testdat
extends the strong and flexible unit testing framework already provided
by testthat with a family of functions and reporting tools focused on
checking data frames.</p>
<p>Features include:</p>
<ul>
<li><p>A fully fledged test framework so you can spend more time
specifying tests and less time running them</p></li>
<li><p>A set of common methods for simply specifying data validation
rules</p></li>
<li><p>Repeatability of data tests (avoid unintentionally breaking your
data set!)</p></li>
<li><p>Data-focused reporting of test results</p></li>
</ul>
<div id="getting-started" class="section level1">
<h1>Getting started</h1>
<p>As an extension of testthat, testdat uses the same basic testing
framework. Before using testdat (and reading this documentation), make
sure youâ€™re familiar with the introduction to testthat in <a href="https://r-pkgs.org/testing-basics.html">R packages</a>.</p>
<p>The main addition provided by testdat is a set of expectations
designed for testing data frames and an accompanying mechanism to
globally specify a data set for testing.</p>
</div>
<div id="data-expectations" class="section level1">
<h1>Data expectations</h1>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>In general, our approach to data testing is variable-centric - the
majority of expectations perform a check on one or more variables in a
given data frame.</p>
<p>The standard form of a data expectation is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>expect_<span class="sc">*</span>(<span class="fu">var</span>(s), ..., <span class="at">flt =</span> <span class="cn">TRUE</span>, <span class="at">data =</span> <span class="fu">get_testdata</span>())</span></code></pre></div>
<p>testdat uses dplyr at its core, and thus supports tidy
evaluation.</p>
<div id="variables" class="section level3">
<h3>Variables</h3>
<p>Most operations act on one or more variables. There are two variants
of the variable argument:</p>
<ul>
<li><code>vars</code> requires a set of columns specified as <a href="https://dplyr.tidyverse.org/reference/dplyr_tidy_select.html">tidy
selections</a>.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;multi-variable identifier is unique&quot;</span>, {</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="fu">expect_unique</span>(<span class="fu">c</span>(name, year, month, day, hour), <span class="at">data =</span> storms)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>})</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: multi-variable identifier is unique â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">#&gt; `storms` has 48 duplicate records on variable `name, year, month, day, hour`.</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">#&gt; Filter: None</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
<ul>
<li><code>var</code> requires an unquoted variable name. This only
applies to a small number of expectations.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;hour values are valid&quot;</span>, {</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="fu">expect_base</span>(ts_diameter, year <span class="sc">&gt;=</span> <span class="dv">2004</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>})</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Error: hour values are valid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; Error: A test data frame has not been specified. Use `set_testdata()` to set the data frame.</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; Backtrace:</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt;     â–†</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt;  1. â””â”€testdat::expect_base(ts_diameter, year &gt;= 2004)</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt;  2.   â”œâ”€testthat::quasi_label(enquo(data))</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;  3.   â”‚ â””â”€rlang::eval_bare(expr, quo_get_env(quo))</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt;  4.   â””â”€testdat::get_testdata()</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
</div>
<div id="filter" class="section level3">
<h3>Filter</h3>
<p>The <code>flt</code> argument takes a logical predicate defined in
terms of the variables in <code>data</code> using <a href="https://dplyr.tidyverse.org/reference/dplyr_data_masking.html">data
masking</a>. Only rows where the condition evaluates to
<code>TRUE</code> are included in the test.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;iris range checks&quot;</span>, {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">expect_range</span>(Petal.Width, <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">data =</span> iris)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>})</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: iris range checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&gt; `iris` has 93 records failing range check on variable `Petal.Width`.</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; Variable set: `Petal.Width`</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; Filter: None</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; Arguments: `min = 0, max = 1`</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;iris range checks filtered&quot;</span>, {</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  <span class="co"># Test passes for setosa rows</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  <span class="fu">expect_range</span>(Petal.Width, <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">flt =</span> Species <span class="sc">==</span> <span class="st">&quot;setosa&quot;</span>, <span class="at">data =</span> iris)</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  <span class="co"># Failures will provide the filter</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  <span class="fu">expect_range</span>(Petal.Width, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="at">flt =</span> Species <span class="sc">==</span> <span class="st">&quot;setosa&quot;</span>, <span class="at">data =</span> iris)</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>})</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: iris range checks filtered â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="co">#&gt; `iris` has 1 records failing range check on variable `Petal.Width`.</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">#&gt; Variable set: `Petal.Width`</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co">#&gt; Filter: `Species == &quot;setosa&quot;`</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="co">#&gt; Arguments: `min = 0, max = 0.5`</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
</div>
<div id="data" class="section level3">
<h3>Data</h3>
<p>The <code>data</code> argument takes a data frame to test. To avoid
redundant code the data argument defaults to a global test data set
retrieved using <code>get_testdata()</code>. This can be used in two
ways:</p>
<ul>
<li>Setting the global test data using <code>set_testdata()</code>.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">set_testdata</span>(iris)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">get_testdata</span>(), iris)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;Versicolor has sepal length greater than 5 - will fail&quot;</span>, {</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="fu">expect_cond</span>(Species <span class="sc">%in%</span> <span class="st">&quot;versicolor&quot;</span>, Sepal.Length <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>})</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: Versicolor has sepal length greater than 5 - will fail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt; get_testdata() failed consistency check. 1 cases have `Species %in% &quot;versicolor&quot;` but not `Sepal.Length &gt;= 5`.</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
<ul>
<li>Using the <code>with_testdata()</code> wrapper to temporarily set
the global test data for a block of code.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">set_testdata</span>(mtcars)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">get_testdata</span>(), mtcars)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">with_testdata</span>(iris, {</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="fu">test_that</span>(<span class="st">&quot;Versicolor has sepal length greater than 5 - will fail&quot;</span>, {</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="fu">expect_cond</span>(Species <span class="sc">%in%</span> <span class="st">&quot;versicolor&quot;</span>, Sepal.Length <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  })</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>})</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: Versicolor has sepal length greater than 5 - will fail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt; get_testdata() failed consistency check. 1 cases have `Species %in% &quot;versicolor&quot;` but not `Sepal.Length &gt;= 5`.</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">get_testdata</span>(), mtcars)</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Both approaches are equivalent to:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;Versicolor has sepal length greater than 5 - will fail&quot;</span>, {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="fu">expect_cond</span>(Species <span class="sc">%in%</span> <span class="st">&quot;versicolor&quot;</span>, Sepal.Length <span class="sc">&gt;=</span> <span class="dv">5</span>, <span class="at">data =</span> iris)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>})</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: Versicolor has sepal length greater than 5 - will fail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt; `iris` failed consistency check. 1 cases have `Species %in% &quot;versicolor&quot;` but not `Sepal.Length &gt;= 5`.</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
<p>By default, <code>set_testdata()</code> stores a quosure with a
reference to the provided data frame rather than the data itself, so
changes made to the data frame will be reflected in the test
results.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>tmp_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>))</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="fu">set_testdata</span>(tmp_data)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">get_testdata</span>())</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 Ã— 2</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">#&gt;       x     y</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co">#&gt; 1     1     1</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">#&gt; 2     0    NA</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="fu">expect_base</span>(y, x <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>tmp_data<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">get_testdata</span>())</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 Ã— 2</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co">#&gt;       x     y</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="co">#&gt; 1     1     1</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co">#&gt; 2     0     1</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="fu">expect_base</span>(y, x <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co">#&gt; Error: get_testdata() has a base mismatch in variable `y`.</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="co">#&gt; 0 cases have `x == 1` but `y` is missing.</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="co">#&gt; 1 cases do not have `x == 1` but `y` is non missing.</span></span></code></pre></div>
</div>
<div id="section" class="section level3">
<h3><code>...</code></h3>
<p>Additional arguments are specific to the expectation. See the help
page for the expectation function for details.</p>
</div>
</div>
<div id="categories" class="section level2">
<h2>Categories</h2>
<p>Data expectations fall into a few main classes.</p>
<dl>
<dt>Value</dt>
<dd>
<p><code>?`date-expectations`</code></p>
</dd>
<dd>
<code>?`label-expectations`</code>
</dd>
<dd>
<code>?`pattern-expectations`</code>
</dd>
<dd>
<code>?`proportion-expectations`</code>
</dd>
<dd>
<code>?`text-expectations`</code>
</dd>
<dd>
<p><code>?`value-expectations`</code></p>
<p>Value expectations test variable values for valid data. Tests include
explicit value checks, pattern checks and others.</p>
</dd>
<dt>Relationships</dt>
<dd>
<p><code>?`exclusivity-expectations`</code></p>
</dd>
<dd>
<p><code>?`uniqueness-expectations`</code></p>
<p>Relationship expectations test for relationships among variables.
Tests include uniqueness and exclusivity checks.</p>
</dd>
<dt>Conditional</dt>
<dd>
<p><code>?`conditional-expectations`</code></p>
<p>Conditional expectations check for the co-existence of multiple
conditions.</p>
</dd>
<dt>Data frame comparison</dt>
<dd>
<p><code>?`datacomp-expectations`</code></p>
<p>Data frame comparison expectations test for consistency between data
frames, for example ensuring similar frequencies between similar
variables in different data frames.</p>
</dd>
<dt>Generic</dt>
<dd>
<p><code>?`generic-expectations`</code></p>
<p>Generic expectations allow for testing of a data frame using an
arbitrary function. The function provided should take a single vector as
its first argument and return a logical vector showing whether each
element has passed or failed. Additional arguments to the checking
function can be passed as a list using the <code>args</code>
argument.</p>
<p>testdat includes a set of useful checking functions. See
<code>?`chk-generic`</code> for details. Several of the checking
functions have a corresponding expectation. These are listed in
<code>?`chk-expect`</code>.</p>
</dd>
</dl>
</div>
</div>
<div id="using-tests" class="section level1">
<h1>Using tests</h1>
<div id="testing-inside-a-script" class="section level2">
<h2>Testing inside a script</h2>
<p>The easiest way to use data testing is directly inside an R script.
Expecations and test blocks throw an error if they fail, so it is very
clear to the user that something needs to be checked, and the script
will fail when sourced.</p>
<p>The example below shows how to adapt a script from exploratory â€œprint
and checkâ€ to a testing approach, using a simple data processing
exercise.</p>
<div id="print-and-check" class="section level3">
<h3>Print and check</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="sc">~</span>id, <span class="sc">~</span>pcode, <span class="sc">~</span>state, <span class="sc">~</span>nsw_only,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="dv">1</span>,   <span class="dv">2000</span>,   <span class="st">&quot;NSW&quot;</span>,  <span class="dv">1</span>,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="dv">2</span>,   <span class="dv">3123</span>,   <span class="st">&quot;VIC&quot;</span>,  <span class="cn">NA</span>,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="dv">3</span>,   <span class="dv">2123</span>,   <span class="st">&quot;NSW&quot;</span>,  <span class="dv">3</span>,</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="dv">4</span>,   <span class="dv">12345</span>,  <span class="st">&quot;VIC&quot;</span>,  <span class="dv">3</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="co"># check id is unique</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">duplicated</span>(id))</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co">#&gt; # A tibble: 0 Ã— 4</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co">#&gt; # â„¹ 4 variables: id &lt;dbl&gt;, pcode &lt;dbl&gt;, state &lt;chr&gt;, nsw_only &lt;dbl&gt;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="co"># check values</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>pcode <span class="sc">%in%</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">3999</span>)</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 Ã— 4</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a><span class="co">#&gt;      id pcode state nsw_only</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a><span class="co">#&gt; 1     4 12345 VIC          3</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">count</span>(state)</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 Ã— 2</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="co">#&gt;   state     n</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a><span class="co">#&gt; 1 NSW       2</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a><span class="co">#&gt; 2 VIC       2</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">count</span>(nsw_only)</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 Ã— 2</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a><span class="co">#&gt;   nsw_only     n</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="co">#&gt;      &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="co">#&gt; 1        1     1</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a><span class="co">#&gt; 2        3     2</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="co">#&gt; 3       NA     1</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="co"># check base for nsw_only variable</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">filter</span>(state <span class="sc">!=</span> <span class="st">&quot;NSW&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">count</span>(nsw_only)</span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 Ã— 2</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="co">#&gt;   nsw_only     n</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a><span class="co">#&gt;      &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a><span class="co">#&gt; 1        3     1</span></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a><span class="co">#&gt; 2       NA     1</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">market =</span> <span class="fu">case_when</span>(pcode <span class="sc">%in%</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2999</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>                                     pcode <span class="sc">%in%</span> <span class="dv">3000</span><span class="sc">:</span><span class="dv">3999</span> <span class="sc">~</span> <span class="dv">2</span>))</span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>x <span class="sc">%&gt;%</span> <span class="fu">count</span>(market)</span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 Ã— 2</span></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a><span class="co">#&gt;   market     n</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a><span class="co">#&gt; 1      1     2</span></span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a><span class="co">#&gt; 2      2     1</span></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a><span class="co">#&gt; 3     NA     1</span></span></code></pre></div>
</div>
<div id="testdat" class="section level3">
<h3>testdat</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(testdat)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="sc">~</span>id, <span class="sc">~</span>pcode, <span class="sc">~</span>state, <span class="sc">~</span>nsw_only,</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="dv">1</span>,   <span class="dv">2000</span>,   <span class="st">&quot;NSW&quot;</span>,  <span class="dv">1</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="dv">2</span>,   <span class="dv">3123</span>,   <span class="st">&quot;VIC&quot;</span>,  <span class="cn">NA</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="dv">3</span>,   <span class="dv">2123</span>,   <span class="st">&quot;NSW&quot;</span>,  <span class="dv">3</span>,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="dv">4</span>,   <span class="dv">12345</span>,  <span class="st">&quot;VIC&quot;</span>,  <span class="dv">3</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>)</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="fu">with_testdata</span>(x, {</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="fu">test_that</span>(<span class="st">&quot;id is unique&quot;</span>, {</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="fu">expect_unique</span>(id)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  })</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  </span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  <span class="fu">test_that</span>(<span class="st">&quot;variable values are correct&quot;</span>, {</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    <span class="fu">expect_values</span>(pcode, <span class="dv">2000</span><span class="sc">:</span><span class="dv">2999</span>, <span class="dv">3000</span><span class="sc">:</span><span class="dv">3999</span>)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    <span class="fu">expect_values</span>(state, <span class="fu">c</span>(<span class="st">&quot;NSW&quot;</span>, <span class="st">&quot;VIC&quot;</span>))</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>    <span class="fu">expect_values</span>(nsw_only, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="co"># by default expect_values allows NAs</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>  })</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  </span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="fu">test_that</span>(<span class="st">&quot;filters applied correctly&quot;</span>, {</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    <span class="fu">expect_base</span>(nsw_only, state <span class="sc">==</span> <span class="st">&quot;NSW&quot;</span>)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>  })</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>})</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="co">#&gt; Test passed ğŸ¥‡</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: variable values are correct â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="co">#&gt; get_testdata() has 1 records failing value check on variable `pcode`.</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co">#&gt; Variable set: `pcode`</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="co">#&gt; Filter: None</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a><span class="co">#&gt; Arguments: `&lt;int: 2000L, 2001L, 2002L, 2003L, 2004L, ...&gt;, &lt;int: 3000L, 3001L, 3002L,`</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="co">#&gt; get_testdata() has 1 records failing value check on variable `pcode`.</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co">#&gt; Variable set: `pcode`</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a><span class="co">#&gt; Filter: None</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="co">#&gt; Arguments: `  3003L, 3004L, ...&gt;, miss = &lt;chr: NA, &quot;&quot;&gt;`</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">market =</span> <span class="fu">case_when</span>(pcode <span class="sc">%in%</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2999</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>                                     pcode <span class="sc">%in%</span> <span class="dv">3000</span><span class="sc">:</span><span class="dv">3999</span> <span class="sc">~</span> <span class="dv">2</span>))</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a><span class="fu">with_testdata</span>(x, {</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>  <span class="fu">test_that</span>(<span class="st">&quot;market derived correctly&quot;</span>, {</span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>    <span class="fu">expect_values</span>(market, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">miss =</span> <span class="cn">NULL</span>) <span class="co"># miss = NULL excludes NAs from valid values</span></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>  })</span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a>})</span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: market derived correctly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a><span class="co">#&gt; get_testdata() has 1 records failing value check on variable `market`.</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a><span class="co">#&gt; Variable set: `market`</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a><span class="co">#&gt; Filter: None</span></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a><span class="co">#&gt; Arguments: `&lt;int: 1L, 2L&gt;, miss = NULL`</span></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
<p>Note that:</p>
<ul>
<li><p>The global test data can be set with <code>set_testdata()</code>
or <code>with_testdata()</code>.</p></li>
<li><p>The <code>test_that()</code> wrapper is not strictly necessary,
but it provides more informative error messaging and logically groups a
set of expectations.</p></li>
<li><p>Each <code>with_testdata()</code> block will fail on the first
<code>test_that()</code> block that fails. The â€œfilters applied
correctlyâ€ test block is not run in the example.</p></li>
</ul>
</div>
</div>
<div id="using-a-test-suite" class="section level2">
<h2>Using a test suite</h2>
<p>Setting up a proper project test suite can be useful for
automatically validating final processed data sets.</p>
<p>Setting up proper file based testing infrastructure is out of the
scope of this vignette. See <a href="https://r-pkgs.org/testing-basics.html">R packages</a> for a brief
introduction to testing infrastructure.</p>
<p>In testthat, related tests are grouped into files. When using
testdat, each file should have a test data set specified with a call to
<code>set_testdata()</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">set_testdata</span>(iris)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;Variable format checks&quot;</span>, {</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">expect_regex</span>(Species, <span class="st">&quot;^[a-z]+$&quot;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>})</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#&gt; Test passed ğŸŒˆ</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&quot;Versicolor has sepal length greater than 5 - will fail&quot;</span>, {</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="fu">expect_cond</span>(Species <span class="sc">%in%</span> <span class="st">&quot;versicolor&quot;</span>, Sepal.Length <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>})</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#&gt; â”€â”€ Failure: Versicolor has sepal length greater than 5 - will fail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#&gt; get_testdata() failed consistency check. 1 cases have `Species %in% &quot;versicolor&quot;` but not `Sepal.Length &gt;= 5`.</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">#&gt; Error:</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">#&gt; ! Test failed</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
